# Документация Carbon PKG / Устройство проекта
Разработка пакетного менеджера - не частая задача в программировании.

carbonpkg - это пакетный менеджер, созданный для упрощения процесса установки программного обеспечения, размещенного на GitHub. Он предоставляет пользователям удобный интерфейс для установки, обновления и удаления пакетов, а также управления зависимостями. В этой документации мы подробно рассмотрим ключевые аспекты работы carbonpkg, включая спецификации пакетов, каталоги, видимость, реестр, версии, локальные файлы, источник правды, контрольные суммы и зависимости.

Эта документация подробно освещает ключевые компоненты работы carbon_pkg, включая спецификацию пакета, каталоги, видимость, реестр, версионирование, локальные файлы, контрольные суммы, а также процесс установки и обновления пакетов.

## Цели и задачи
Цели нашего пакетного менеджера:

 + **Упрощение управления пакетами** - часто может потребоваться создание "песочницы" или виртуального окружения для тестирования пакетов. Виртуальные пакеты не влияют на общий список системных пакетов. Также пользователь может изменять некоторые параметры уже установленного проекта, если разработчик допускает это.
 + **Безопасность** - используются контрольные суммы и проверка целостности и оригинальности пакета перед их установкой. В будущем также планируется добавить поиск уязвимостей пакета при установке.
 + **Поддержка версионирования** - поддерживать возможность наличия пакетов разных версий в одной системе.

Задачи:

1. Обеспечение интеграции с Git и GitHub.
2. Предоставление средств для управления зависимостями.
3. Гибкая конфигурация и интеграция в разные системы.
4. Сделать пакеты и сам пакетный менеджер более независимым от системы и платформы.
5. Настроить систему защиты от повреждения пакетов (например, установка была завершена по внешним причинам).
6. Сделать пакетный менеджер универсальным и удобным.

## Архитектура проекта
На момент планирования, carbon_pkg состоит из нескольких ключевых компонентов:

1. Парсер спецификации пакета (json, toml, yaml): загрузка и обработка спецификации пакета, а также парсинг пользовательской конфигурации пакетного менеджера.
2. РНП - Реестр надежных пакетов (trusted package registry - TPR). Реестр содержит два типа пакетов: Diamond-package и Monoxide-Package. Названия образованы от химических соединений углерода. Diamond-package - надежный проверенный пакет, а monoxide-package это опасный пакет, содержащий уязвимости или другие проблемы. Так помечаются пакеты до их удаления или решения проблемы. Monoxide-пакетами могут стать даже обычные пакеты, в которых обнаружили серьезную уязвимость.
3. Клиентская и серверная часть: сервер содержит в себе РНП и через него проходят все операции. Клиент же отвечает за взаимодействие с пользователем и его системой.
4. Система версионирования: механизм, позволяющий работать с пакетами. Особенно полезен при наличии пакета с несколькими версиями.
5. Безопасность: отвечает за контрольные суммы, уязвимости и защиту от повреждения пакетов.

## Структура файла конфигурации пакетного менеджера
По умолчанию хранится в `~/.config/carbon_pkg/default/carbonpkg_settings.json`:

```json
{
	"install_monoxide": false,
	"always_skip_trp": false,
	"timeout": 30,
	"security" {
		"verify_checksums": true,
	},
	"install": {
		"install_location": "/usr/local/bin"
	},
	"backup": {
		"enabled": true,
		"backup_location": "~/.carbon_pkg_backups"
	}
}
```

 + `install_monoxide` - разрешает устанавливать в систему потенциально опасные monoxide-пакеты.
 + `always_skip_trp` - пакет пропускает этап проверки на Trusted Package Registry и переходит сразу к установке.
 + `timeout` - таймаут ожидания ответа от сервера реестра.
 + `security` - настройки безопасности.
   - `verify_checksums` - проверять ли контрольные суммы.
 + `install` - настройки установки.
   - `install_location` - локация установки пакетов.
 + `backup` - настройки бекапа.
   - `enabled` - включение бекапов.
   - `backup_location` - локация сохранения бекапов.

## Структура спецификации пакета
Файл спецификации пакета в формате json выглядит следующим образом:

```json
{
	"owner": "alexeev-pkg",
	"name": "carbon_pkg",
	"package_type": "binary",
	"description": "Blazing fast and modern package manager written in Golang",
	"maintainer": "Alexeev Bronislav <alexeev.dev@mail.ru>"
	"tags": ["package manager", "package", "golang", "fast"]
	"version": "latest",
	"languages": ["go"],
	"supported_architectures": ["amd64", "arm"],
	"license": "GNU LGPL v2.1",
	"repository": "https://github.com/alexeev-prog/carbon_pkg",
	"homepage": "https://github.com/alexeev-prog/carbon_pkg",
	"user-configurable": true,

	"raw_source": {
		"type": "git",
		"url": "{repository}.git",
		"branch": "main"
	},

	"assets": {
		"default": "github-release",
		"github-release": {
			"path": "{repository}/releases/download/{version}",

			"files": {
				"linux-amd64": "carbonpkg-{version}-linux-amd64.tar.gz"
			}

			"checksums": "checksums.txt"
		},
		"building": {
			"commands": [],
			"output_files": [],
			"building_instructions_file": "BUILDING.md"
		}
	},
}
```

 + `owner` - владелец пакета.
 + `name` - имя пакета.
 + `package_type` - тип пакета.
 + `description` - краткое описание проекта.
 + `maintainer` - информация о мейнтейнере проекта.
 + `tags` - список тегов пакета.
 + `version` - версия (latest или конкретная версия) пакета.
 + `languages` - список языков, на котором написан исходный код проекта.
 + `supported_architectures` - поддерживаемые архитектуры процессора.
 + `license` - лицензия.
 + `repository` - репозиторий пакета.
 + `homepage` - домашняя страница пакета.
 + `user-configurable` - позволяет пользователю изменять некоторые параметры спецификации проекта для себя.
 + `raw_source` - сырые исходники:
   - `type` - тип.
   - `url` - URL-адрес
   - `branch` - ветка (обязательна для типа: git).
 + `assets` - ассеты проекта. Поддерживаются разные виды (github-release, building):
   - `default` - тип по умолчанию.
   - `github-release` - установка релиза через github api:
     - `path` - путь (ссылка).
     - `files` - словарь с файлами.
     - `checksums` - контрольные суммы
   - `building` - сборка (нестабильно):
     - `commands` - список команд для сборки.
     - `output_files` - список итоговых файлов.
     - `building_instructions_file` - файл инструкции по сборке (пакетный менеджер выведет его если во время автоматической сборки возникнет ошибка).

---

[Содержание](./index.md)
